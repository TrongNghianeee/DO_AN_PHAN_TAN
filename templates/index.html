<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enrollment Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-3">Đăng Ký Khóa Học</h1>
        <form id="regForm">
            <div class="mb-3">
                <label>Student ID:</label>
                <input type="text" class="form-control" id="student_input" placeholder="Gõ id hoặc tên để tìm..." autocomplete="off" required>
                <div id="student_suggestions" class="list-group" style="position: absolute; z-index:1000;
                    max-height:200px; overflow:auto; display:none; width:100%;"></div>
                <input type="hidden" id="stno">
                <input type="hidden" id="student_display">
                <input type="hidden" id="shard">
            </div>
            <div class="mb-3">
                <label>Section ID:</label>
                <select class="form-select" id="sec_no" required>
                    <option value="">-- Chọn section --</option>
                </select>
            </div>
            <!-- u_id removed: determined automatically -->
            <button type="submit" class="btn btn-primary">Đăng Ký</button>
            <button type="button" id="btnList" class="btn btn-secondary ms-2">Xem Danh Sách</button>
        </form>

        <div class="mt-4">
            <h3>Danh sách đăng ký (Master DB)</h3>
            <table class="table table-bordered" id="regTable">
                <thead>
                    <tr>
                        <th>Reg ID</th>
                        <th>Student</th>
                        <th>Shard</th>
                        <th>Section</th>
                        <th>Course</th>
                        <th>Term</th>
                        <th>Created</th>
                        <th>Synced</th>
                        <th>Latency</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Submit form đăng ký - u_id is auto-detected by server
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                stno: document.getElementById('stno').value,
                sec_no: document.getElementById('sec_no').value,
                student_display: document.getElementById('student_display').value,
                shard: document.getElementById('shard').value || undefined
            };
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            alert(JSON.stringify(result));
        });

        // Lấy danh sách từ API /list
        document.getElementById('btnList').addEventListener('click', async () => {
            const res = await fetch('/registrations');
            const rows = await res.json();
            const tbody = document.querySelector('#regTable tbody');
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.reg_id}</td>
                    <td>${r.student_name || r.master_stno}</td>
                    <td>${r.shard || ''}</td>
                    <td>${r.master_sec_no}</td>
                    <td>${r.course_no} - ${r.course_name || ''}</td>
                    <td>${r.year} ${r.semester}</td>
                    <td>${r.created_at}</td>
                    <td>${r.synced_at || ''}</td>
                    <td>${r.latency || ''}</td>`;
                tbody.appendChild(tr);
            });
        });
    </script>
    <script>
        // Autocomplete students
        const input = document.getElementById('student_input');
        const suggestions = document.getElementById('student_suggestions');
        const hiddenStno = document.getElementById('stno');

        let debounceTimer;
        input.addEventListener('input', (e) => {
            const q = e.target.value.trim();
            clearTimeout(debounceTimer);
            if (!q) { suggestions.style.display='none'; return; }
            debounceTimer = setTimeout(async () => {
                const res = await fetch('/students?q=' + encodeURIComponent(q));
                const items = await res.json();
                suggestions.innerHTML = '';
                if (!items || items.length === 0) { suggestions.style.display='none'; return; }
                items.forEach(it => {
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'list-group-item list-group-item-action';
                    el.textContent = it.display + (it.shard ? (' [shard '+it.shard+']') : '');
                    el.dataset.stno = it.stno;
                    el.dataset.shard = it.shard || '';
                    el.addEventListener('click', () => {
                        input.value = it.display;
                        hiddenStno.value = it.stno;
                        document.getElementById('student_display').value = (it.display || '').replace(/ \(id=.*\)$/, '').trim();
                        document.getElementById('shard').value = it.shard || '';
                        loadSections(it.stno, it.shard);
                        suggestions.style.display='none';
                    });
                    suggestions.appendChild(el);
                });
                suggestions.style.display = 'block';
            }, 250);
        });

        // click outside to hide suggestions
        document.addEventListener('click', (e) => {
            if (!suggestions.contains(e.target) && e.target !== input) {
                suggestions.style.display = 'none';
            }
        });

    async function loadSections(stno, shard) {
            const sel = document.getElementById('sec_no');
            sel.innerHTML = '<option value="">-- Chọn section --</option>';
            try {
        const url = '/sections/available/' + stno + (shard ? ('?shard=' + shard) : '');
        const res = await fetch(url);
                const items = await res.json();
                if (!Array.isArray(items)) {
                    alert('Lỗi khi lấy danh sách section');
                    return;
                }
    // detectShard removed: backend now returns shard directly
                items.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.sec_no;
                    opt.textContent = `${s.sec_no} — ${s.course_name} (enrolled ${s.enrolled}/${s.capacity || '∞'}) — ${s.instructor || 'TBA'}`;
                    sel.appendChild(opt);
                });
            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
